# Scheduleing

2023-07-29

---

Job queue 나 batch로 한 번에 처리하는 작업을 어떻게 잘 만들까

- 매월 특정일 구독 결제 처리
- 시간별 예약 발송 메시지 발송 처리

구독 결제의 경우 DB에서 구독데이터를 1천 개씩 질의하고 서버 메모리에서 1천 개의 구독 데이터를 순회하면서 결제하고 성공, 실패 여부 등을 기록했다. 결제는 PG 처리가 최소 1초는 소요 되기 때문에 서비스가 엄청 유명해저서 하루 결제 처리 해야하는 건수가 10만 건이면 최소 처리 시간이 10만초로 하루 24시간인 86400초 보다 오래 걸리기 때문에 scscalability 하지 않는다. 물론 순회 할때 내부적으로 스레드를 만들어 동시에 2건 씩 결제 하게 하여 이 상태로도 서비스 운영에는 문제가 없다.

하지만 예약 메시지 같은 시스템은 어떨까? 결제는 정확히 그 시간에 결제 할필요가 없다. 정확히 그날짜만 맞추면 될뿐.. 그러나 예약 메시지는 다르다. 보통 분단위로 예약 메시지를 설정 하도록 서비스들은 구현되어있다. 이말은 14일 15시 12분에 발송 예약건수가 5만건이라면 mobile push든 email이든 외부 발송 서비스에 5만건을 1분 안에 보내야 하기 때문에 결제를 구현했던 방식으로는 유저가 예약 설정한 그 시간안에 발송 하기는 힘들것 같다.

결국 job queue를 만들어 worker 역할을 하는애는 쌓인 task를 처리하게만 하고 job queue에 계속 쌓게 하면 될거 같은데 좀더 고민을 해봐야 겠다.